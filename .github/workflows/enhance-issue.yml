name: Enhance Issue with AI

on:
  issues:
    types: [ opened ]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to enhance'
        required: true
        type: number

permissions:
  issues: write

env:
  AI_MODEL: "gpt-4o"
  AI_TEMPERATURE: "0.3"
  SYSTEM_PROMPT: |
    You are an expert in analyzing and concisely summarizing GitHub issues.

    ## Role
    Analyze the issue written by the user (Who, What, Why) and summarize only the key points.
    If images are included, analyze the image content as well.

    ## Writing Rules
    - MUST write in Korean language
    - Maximum 5 lines
    - Present only the core problem and solution direction
    - Write in paragraph format without unnecessary sections or checklists

    ## Output Format
    JSON format:
    {
      "summary": "Concise Korean summary within 5 lines (반드시 한글로 작성)"
    }

  USER_PROMPT_TEMPLATE: |
    Please analyze the following issue and provide a concise summary within 5 lines.

    **Title**: {TITLE}
    **Who**: {WHO}
    **What**: {WHAT}
    **Why**: {WHY}

    {IMAGE_NOTE}

    Briefly summarize what the core problem is, what type of issue it is, and what the solution direction is.
    IMPORTANT: Write the summary in Korean language within 5 lines.

jobs:
  enhance-issue:
    runs-on: ubuntu-latest
    steps:
      - name: Get Issue Details
        id: get-issue
        uses: actions/github-script@v7
        with:
          script: |
            // Check trigger type
            const isManualTrigger = context.eventName === 'workflow_dispatch';
            console.log(`Trigger type: ${isManualTrigger ? 'Manual (workflow_dispatch)' : 'Automatic (issue opened)'}`);

            let issue;
            let issueNumber;

            if (isManualTrigger) {
              // Manual trigger: get issue number from input and fetch issue
              issueNumber = parseInt(context.payload.inputs.issue_number);
              console.log(`Fetching issue #${issueNumber}...`);

              try {
                const { data } = await github.rest.issues.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber
                });
                issue = data;
                console.log(`✓ Issue #${issueNumber} found: ${issue.title}`);
              } catch (error) {
                console.error(`❌ Failed to fetch issue #${issueNumber}: ${error.message}`);
                core.setFailed(`Issue #${issueNumber} not found or inaccessible`);
                throw error;
              }
            } else {
              // Automatic trigger: get issue from webhook payload
              issue = context.payload.issue;
              issueNumber = issue.number;
            }

            const title = issue.title;
            const body = issue.body || '';

            console.log(`Processing issue #${issueNumber}: ${title}`);
            console.log(`Body length: ${body.length} characters`);

            core.setOutput('title', title);
            core.setOutput('body', body);
            core.setOutput('number', issueNumber);

            return { title, body, number: issueNumber };

      - name: Check if Already Enhanced
        id: check-enhanced
        uses: actions/github-script@v7
        with:
          script: |
            const body = '${{ steps.get-issue.outputs.body }}';

            if (body.includes('## AI 분석')) {
              console.log('✓ Issue already enhanced with AI analysis');
              core.setOutput('skip', 'true');
              return { skip: true };
            }

            console.log('→ Issue needs enhancement');
            core.setOutput('skip', 'false');
            return { skip: false };

      - name: Extract Content and Images
        id: extract-content
        if: steps.check-enhanced.outputs.skip != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const body = `${{ steps.get-issue.outputs.body }}`;
            const lines = body.split('\n');

            let who = '';
            let what = '';
            let why = '';

            // Parse who, what, why from issue body
            for (let i = 0; i < lines.length; i++) {
              const line = lines[i].trim();

              // Check for both Korean and English headers
              if (line.startsWith('### who') || line.startsWith('### Who') || line.startsWith('### 누가')) {
                if (i + 1 < lines.length) {
                  who = lines[i + 1].trim();
                }
              } else if (line.startsWith('### what') || line.startsWith('### What') || line.startsWith('### 무엇을')) {
                if (i + 1 < lines.length) {
                  what = lines[i + 1].trim();
                }
              } else if (line.startsWith('### why') || line.startsWith('### Why') || line.startsWith('### 왜')) {
                // Why can be multiple lines
                let whyLines = [];
                for (let j = i + 1; j < lines.length; j++) {
                  if (lines[j].trim().startsWith('###')) break;
                  if (lines[j].trim()) {
                    whyLines.push(lines[j].trim());
                  }
                }
                why = whyLines.join(' ');
              }
            }

            // Extract image URLs from markdown
            const imageRegex = /!\[.*?\]\((https?:\/\/[^\)]+)\)/g;
            const matches = [...body.matchAll(imageRegex)];
            const imageUrls = matches.map(match => match[1]).slice(0, 10); // Max 10 images

            console.log(`Extracted content:`);
            console.log(`  Who: ${who || 'Not specified'}`);
            console.log(`  What: ${what || 'Not specified'}`);
            console.log(`  Why: ${why || 'Not specified'}`);
            console.log(`  Images found: ${imageUrls.length}`);

            core.setOutput('who', who);
            core.setOutput('what', what);
            core.setOutput('why', why);
            core.setOutput('image_urls', JSON.stringify(imageUrls));

            return { who, what, why, imageUrls };

      - name: Call OpenAI API
        id: call-api
        if: steps.check-enhanced.outputs.skip != 'true'
        uses: actions/github-script@v7
        env:
          TITLE: ${{ steps.get-issue.outputs.title }}
          WHO: ${{ steps.extract-content.outputs.who }}
          WHAT: ${{ steps.extract-content.outputs.what }}
          WHY: ${{ steps.extract-content.outputs.why }}
          IMAGE_URLS: ${{ steps.extract-content.outputs.image_urls }}
        with:
          script: |
            const https = require('https');

            // Get environment variables
            const title = process.env.TITLE;
            const who = process.env.WHO || 'Not specified';
            const what = process.env.WHAT || 'Not specified';
            const why = process.env.WHY || 'Not specified';
            const imageUrls = JSON.parse(process.env.IMAGE_URLS || '[]');

            // Prepare user prompt
            const userPromptTemplate = process.env.USER_PROMPT_TEMPLATE;
            const imageNote = imageUrls.length > 0
              ? `Please also analyze the ${imageUrls.length} attached image(s).`
              : '';

            const userPrompt = userPromptTemplate
              .replace('{TITLE}', title)
              .replace('{WHO}', who)
              .replace('{WHAT}', what)
              .replace('{WHY}', why)
              .replace('{IMAGE_NOTE}', imageNote);

            console.log('Preparing API request...');

            // Build content array (text + images)
            const contentArray = [
              {
                type: "text",
                text: userPrompt
              }
            ];

            // Add images to content array
            imageUrls.forEach(url => {
              contentArray.push({
                type: "image_url",
                image_url: { url }
              });
            });

            // Prepare API request
            const requestBody = JSON.stringify({
              model: process.env.AI_MODEL,
              messages: [
                {
                  role: 'system',
                  content: process.env.SYSTEM_PROMPT
                },
                {
                  role: 'user',
                  content: contentArray
                }
              ],
              temperature: parseFloat(process.env.AI_TEMPERATURE),
              response_format: { type: "json_object" },
              max_tokens: 500
            });

            const options = {
              hostname: 'api.openai.com',
              path: '/v1/chat/completions',
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${{ secrets.OPENAI_API_KEY }}`,
                'Content-Length': Buffer.byteLength(requestBody)
              }
            };

            // Make API call
            const apiCall = () => {
              return new Promise((resolve, reject) => {
                const req = https.request(options, (res) => {
                  let data = '';

                  res.on('data', (chunk) => {
                    data += chunk;
                  });

                  res.on('end', () => {
                    if (res.statusCode === 200) {
                      try {
                        const parsed = JSON.parse(data);
                        resolve(parsed);
                      } catch (e) {
                        reject(new Error(`Failed to parse API response: ${e.message}`));
                      }
                    } else {
                      reject(new Error(`API call failed with status ${res.statusCode}: ${data}`));
                    }
                  });
                });

                req.on('error', (error) => {
                  reject(new Error(`Network error: ${error.message}`));
                });

                req.write(requestBody);
                req.end();
              });
            };

            try {
              console.log('→ Calling OpenAI API...');
              const response = await apiCall();

              if (!response.choices || !response.choices[0]) {
                throw new Error('Invalid API response structure');
              }

              const content = JSON.parse(response.choices[0].message.content);
              const summary = content.summary;

              console.log('✓ API call successful');
              console.log(`Summary length: ${summary.length} characters`);

              core.setOutput('summary', summary);
              return { success: true, summary };

            } catch (error) {
              console.error('❌ API call failed:', error.message);
              core.setOutput('error', error.message);
              core.setFailed(error.message);
              return { success: false, error: error.message };
            }

      - name: Update Issue Body
        id: update-issue
        if: steps.check-enhanced.outputs.skip != 'true' && steps.call-api.outputs.summary
        uses: actions/github-script@v7
        env:
          ISSUE_NUMBER: ${{ steps.get-issue.outputs.number }}
          ORIGINAL_BODY: ${{ steps.get-issue.outputs.body }}
          AI_SUMMARY: ${{ steps.call-api.outputs.summary }}
        with:
          script: |
            const issueNumber = parseInt(process.env.ISSUE_NUMBER);
            const originalBody = process.env.ORIGINAL_BODY;
            const aiSummary = process.env.AI_SUMMARY;

            // Construct new body with AI analysis
            const newBody = `${originalBody}\n\n---\n\n## AI 분석\n\n${aiSummary}\n\n---\n*이 내용은 AI에 의해 자동으로 생성되었습니다.*`;

            try {
              // Update the issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: newBody
              });

              console.log(`✓ Issue #${issueNumber} updated successfully`);
              core.setOutput('updated', 'true');

            } catch (error) {
              console.error(`❌ Failed to update issue: ${error.message}`);
              core.setOutput('error', error.message);
              throw error;
            }

      - name: Add Notification Comment
        if: steps.update-issue.outputs.updated == 'true'
        uses: actions/github-script@v7
        env:
          ISSUE_NUMBER: ${{ steps.get-issue.outputs.number }}
        with:
          script: |
            const issueNumber = parseInt(process.env.ISSUE_NUMBER);
            const isManualTrigger = context.eventName === 'workflow_dispatch';

            const message = isManualTrigger
              ? '✅ AI가 이슈를 분석하여 요약을 추가했습니다. (수동 실행)'
              : '✅ AI가 이슈를 분석하여 요약을 추가했습니다.';

            try {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: message
              });

              console.log(`✓ Comment added to issue #${issueNumber}`);

            } catch (error) {
              console.error(`⚠️ Failed to add comment: ${error.message}`);
              // Don't fail the workflow for comment errors
            }
