name: Setup Repository Labels

on:
  workflow_dispatch: # Manual trigger for one-time setup

jobs:
  setup-labels:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Labels
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // Define standardized labels
            // Maximum 2 emojis used: ğŸ”¥ (critical) and ğŸ› (bug)
            const standardLabels = [
              // Priority labels (using ğŸ”¥ emoji)
              {
                name: 'ğŸ”¥ priority: critical',
                color: 'b60205',
                description: 'ê¸´ê¸‰í•˜ê²Œ ì²˜ë¦¬ê°€ í•„ìš”í•œ ì´ìŠˆ'
              },
              {
                name: 'priority: high',
                color: 'd93f0b',
                description: 'ë†’ì€ ìš°ì„ ìˆœìœ„'
              },
              {
                name: 'priority: medium',
                color: 'fbca04',
                description: 'ì¤‘ê°„ ìš°ì„ ìˆœìœ„'
              },
              {
                name: 'priority: low',
                color: '0e8a16',
                description: 'ë‚®ì€ ìš°ì„ ìˆœìœ„'
              },

              // Type labels (using ğŸ› emoji for bug)
              {
                name: 'type: feature',
                color: '0052cc',
                description: 'ìƒˆë¡œìš´ ê¸°ëŠ¥ ìš”ì²­'
              },
              {
                name: 'ğŸ› type: bug',
                color: 'd73a4a',
                description: 'ë²„ê·¸ ë¦¬í¬íŠ¸'
              },
              {
                name: 'type: enhancement',
                color: 'a2eeef',
                description: 'ê¸°ì¡´ ê¸°ëŠ¥ ê°œì„ '
              },
              {
                name: 'type: documentation',
                color: '0075ca',
                description: 'ë¬¸ì„œ ì‘ì—…'
              },
              {
                name: 'type: question',
                color: 'd876e3',
                description: 'ì§ˆë¬¸ ë˜ëŠ” ë…¼ì˜'
              },
              {
                name: 'type: refactor',
                color: 'fbca04',
                description: 'ì½”ë“œ ë¦¬íŒ©í† ë§'
              },
              {
                name: 'type: test',
                color: '1d76db',
                description: 'í…ŒìŠ¤íŠ¸ ê´€ë ¨'
              },

              // Status labels
              {
                name: 'status: in-progress',
                color: 'fbca04',
                description: 'ì‘ì—… ì§„í–‰ ì¤‘'
              },
              {
                name: 'status: review',
                color: '0e8a16',
                description: 'ë¦¬ë·° ëŒ€ê¸° ì¤‘'
              },
              {
                name: 'status: blocked',
                color: 'd93f0b',
                description: 'ì°¨ë‹¨ë¨'
              },
              {
                name: 'status: on-hold',
                color: 'e1e4e8',
                description: 'ë³´ë¥˜ë¨'
              },
              {
                name: 'status: completed',
                color: '0e8a16',
                description: 'ì™„ë£Œë¨'
              },

              // Area labels
              {
                name: 'area: backend',
                color: '5319e7',
                description: 'ë°±ì—”ë“œ ê´€ë ¨'
              },
              {
                name: 'area: frontend',
                color: 'c2e0c6',
                description: 'í”„ë¡ íŠ¸ì—”ë“œ ê´€ë ¨'
              },
              {
                name: 'area: database',
                color: '006b75',
                description: 'ë°ì´í„°ë² ì´ìŠ¤ ê´€ë ¨'
              },
              {
                name: 'area: api',
                color: 'f9d0c4',
                description: 'API ê´€ë ¨'
              },
              {
                name: 'area: infra',
                color: 'bfd4f2',
                description: 'ì¸í”„ë¼ ê´€ë ¨'
              },

              // Other labels
              {
                name: 'good first issue',
                color: '7057ff',
                description: 'ì²˜ìŒ ê¸°ì—¬í•˜ê¸° ì¢‹ì€ ì´ìŠˆ'
              },
              {
                name: 'help wanted',
                color: '008672',
                description: 'ë„ì›€ì´ í•„ìš”í•œ ì´ìŠˆ'
              },
              {
                name: 'duplicate',
                color: 'cfd3d7',
                description: 'ì¤‘ë³µëœ ì´ìŠˆ'
              },
              {
                name: 'invalid',
                color: 'e4e669',
                description: 'ìœ íš¨í•˜ì§€ ì•Šì€ ì´ìŠˆ'
              },
              {
                name: 'wontfix',
                color: 'e1e4e8',
                description: 'ìˆ˜ì •í•˜ì§€ ì•Šì„ ì´ìŠˆ'
              }
            ];

            console.log('Starting label setup process...');

            // Step 1: Get all existing labels
            console.log('\n[Step 1] Fetching existing labels...');
            let existingLabels = [];
            try {
              const response = await github.rest.issues.listLabelsForRepo({
                owner,
                repo,
                per_page: 100
              });
              existingLabels = response.data;
              console.log(`Found ${existingLabels.length} existing labels`);
            } catch (error) {
              const msg = error.message;
              console.log(`Error fetching labels or no labels: ${msg}`);
            }

            // Step 2: Delete all existing labels
            console.log('\n[Step 2] Deleting existing labels...');
            for (const label of existingLabels) {
              try {
                await github.rest.issues.deleteLabel({
                  owner,
                  repo,
                  name: label.name
                });
                console.log(`  âœ“ Deleted: ${label.name}`);
              } catch (error) {
                const msg = error.message;
                console.log(`  âœ— Failed to delete ${label.name}: ${msg}`);
              }
            }

            // Step 3: Create new standardized labels
            console.log('\n[Step 3] Creating standardized labels...');
            let successCount = 0;
            let failCount = 0;

            for (const label of standardLabels) {
              try {
                await github.rest.issues.createLabel({
                  owner,
                  repo,
                  name: label.name,
                  color: label.color,
                  description: label.description
                });
                console.log(`  âœ“ Created: ${label.name}`);
                successCount++;
              } catch (error) {
                const msg = error.message;
                console.log(`  âœ— Failed to create ${label.name}: ${msg}`);
                failCount++;
              }
            }

            // Step 4: Summary
            console.log('\n[Summary]');
            console.log(`  Deleted: ${existingLabels.length} labels`);
            console.log(`  Created: ${successCount} labels`);
            console.log(`  Failed: ${failCount} labels`);
            console.log('\nâœ¨ Label setup completed!');
